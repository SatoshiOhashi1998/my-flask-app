{% extends "format.html" %}

{% block head %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

<style>
/* 共通スタイル */
#videoPlayer { width:100%; height:auto; margin:20px 0; border:2px solid #ccc; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
label { font-weight:bold; margin-top:15px; display:block; }
input[type="text"], select, input[type="range"] { width:100%; padding:10px; margin-bottom:15px; border:1px solid #ccc; border-radius:5px; box-shadow:0 1px 5px rgba(0,0,0,0.1); }
h1 { font-size:24px; margin-bottom:20px; color:#333; }
#filterInput { background-color:#f9f9f9; border:1px solid #aaa; }
.section { margin-bottom:30px; }
.button { background-color:#007BFF; color:white; border:none; padding:21px 30px; font-size:20px; border-radius:8px; cursor:pointer; margin-top:15px; display:inline-block; transition:background-color 0.3s ease; touch-action:manipulation; }
.button:hover { background-color:#0056b3; }
#controlSection .button { margin-right:10px; }
.control-buttons { display:flex; justify-content:center; gap:40px; margin-top:15px; }
.select2-container--default .select2-results>.select2-results__options { max-height:400px; overflow-y:auto; }
</style>
{% endblock %}

{% block body %}
<div class="section">
    <label for="videoSelect">動画選択:</label>
    <select id="videoSelect"></select>
</div>

<div class="section">
    <label for="playMode">再生モード:</label>
    <select id="playMode">
        <option value="loop">ループ再生</option>
        <option value="sequential">順番通りに再生</option>
        <option value="random">ランダムな順番で再生</option>
    </select>
</div>

<video id="videoPlayer" controls>
    <source id="videoSource" src="" type="video/mp4">
    お使いのブラウザは動画タグに対応していません。
</video>

<div class="section" id="controlSection">
    <label for="volumeControl">音量調整:</label>
    <input type="range" id="volumeControl" min="0" max="100" value="100">

    <label for="progressBar">再生位置:</label>
    <input type="range" id="progressBar" min="0" max="100" value="0">

    <label for="speedControl">再生速度:</label>
    <input type="range" id="speedControl" min="0.5" max="2.0" step="0.1" value="1">

    <div class="control-buttons">
        <button class="button" id="rewind10">⏪ 10秒戻る</button>
        <button class="button" id="forward10">⏩ 10秒進む</button>
        <button class="button" id="fullscreenBtn">🖵 全画面</button>
    </div>
</div>

<script>
$(function() {
    const videoPlayer = $('#videoPlayer')[0];
    const select = $('#videoSelect');
    const progressBar = $('#progressBar');
    const speedControl = $('#speedControl');

    const videoQueue = {{ data['items'] | tojson }};
    let currentIndex = 0;
    let playMode = {{ data.mode | tojson }} || 'loop';
    let isSeeking = false;

    // ------------------------------
    // 初期化関数
    // ------------------------------
    function initVideoSelect() {
        videoQueue.forEach(item => {
            const dirName = item.dirpath.replace(/\\/g, '/').split('/').pop();
            const videoPath = `static/video/${dirName}/${item.filename}`;
            select.append($('<option>').text(item.filetitle).val(videoPath));
        });

        select.select2({ placeholder: '動画を選択', allowClear: true, width: '100%' });

        const initialVideoTitle = {{ data.v | tojson }};
        let firstOption = select.find('option:first');
        let firstVideoPath = firstOption.val();
        if (initialVideoTitle) {
            const matchOption = select.find('option').filter((i,opt) => $(opt).text() === initialVideoTitle);
            if (matchOption.length) firstVideoPath = matchOption.val();
        }
        select.val(firstVideoPath).trigger('change');
        $('#videoSource').attr('src', firstVideoPath);
        videoPlayer.load();
        document.title = select.find('option:selected').text();
    }

    // ------------------------------
    // 再生モード管理
    // ------------------------------
    function playNextVideo() {
        const options = select.find('option').map((i,opt) => $(opt).val()).get();
        if (!options.length) return;

        switch(playMode) {
            case 'loop':
                videoPlayer.currentTime = 0;
                videoPlayer.play();
                break;
            case 'sequential':
                currentIndex = (currentIndex + 1) % options.length;
                select.val(options[currentIndex]).trigger('change');
                break;
            case 'random':
                currentIndex = Math.floor(Math.random() * options.length);
                select.val(options[currentIndex]).trigger('change');
                break;
        }
    }

    // ------------------------------
    // イベント登録
    // ------------------------------
    videoPlayer.addEventListener('ended', playNextVideo);

    $('#playMode').val(playMode).change(function() { playMode = $(this).val(); });

    select.on('change', function() {
        const selectedVideo = $(this).val();
        currentIndex = $(this).prop('selectedIndex');
        if (selectedVideo) {
            $('#videoSource').attr('src', selectedVideo);
            document.title = $(this).find('option:selected').text();
            videoPlayer.load();
            videoPlayer.onloadedmetadata = () => videoPlayer.play();
            $('#videoPlayer').show();
        } else { $('#videoPlayer').hide(); }
    });

    $('#volumeControl').on('input', function() { videoPlayer.volume = $(this).val()/100; });
    speedControl.on('input', function() { videoPlayer.playbackRate = parseFloat($(this).val()); });

    $('#rewind10').click(()=>seekBy(-10));
    $('#forward10').click(()=>seekBy(10));

    function seekBy(sec) {
        videoPlayer.currentTime = Math.min(Math.max(0, videoPlayer.currentTime + sec), videoPlayer.duration);
    }

    videoPlayer.addEventListener('timeupdate', () => {
        if(!isSeeking && videoPlayer.duration) progressBar.val((videoPlayer.currentTime/videoPlayer.duration)*100);
    });

    progressBar.on('input', function() {
        isSeeking = true;
        videoPlayer.currentTime = (videoPlayer.duration * $(this).val())/100;
    }).on('change', () => isSeeking=false);

    $('#fullscreenBtn').click(toggleFullscreen);

    function toggleFullscreen() {
        if(!document.fullscreenElement) videoPlayer.requestFullscreen().catch(err=>console.error(err));
        else document.exitFullscreen();
    }

    $(document).keydown(handleShortcuts);

    function handleShortcuts(e){
        switch(e.key){
            case "ArrowLeft": seekBy(-10); break;
            case "ArrowRight": seekBy(10); break;
            case "ArrowUp": setVolume(0.05); break;
            case "ArrowDown": setVolume(-0.05); break;
            case " ": e.preventDefault(); videoPlayer.paused ? videoPlayer.play() : videoPlayer.pause(); break;
            case "f": toggleFullscreen(); break;
        }
    }

    function setVolume(delta){
        videoPlayer.volume = Math.min(1, Math.max(0, videoPlayer.volume + delta));
        $('#volumeControl').val(videoPlayer.volume*100);
    }

    // ------------------------------
    // 初期化呼び出し
    // ------------------------------
    initVideoSelect();
});
</script>
{% endblock %}
